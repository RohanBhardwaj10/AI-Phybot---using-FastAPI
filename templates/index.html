<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI PhyBot — Chat</title>
  <style>
    :root{
      --bg:#f3f6fb;
      --card:#ffffff;
      --user:#DCF8C6;
      --bot:#eef2f5;
      --accent:#2463eb;
      --muted:#6b7280;
    }
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,#e9f0ff 0%,var(--bg) 100%);display:flex;align-items:center;justify-content:center;padding:24px;}
    .app {
      width:100%;
      max-width:880px;
      min-height:640px;
      background:var(--card);
      border-radius:12px;
      box-shadow:0 10px 30px rgba(16,24,40,0.08);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    /* header */
    .app-header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:18px 22px;
      border-bottom:1px solid #eef2f6;
    }
    .logo{
      width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#2b6ef6,#8fd3ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px;
      box-shadow:0 4px 10px rgba(37,99,235,0.15);
    }
    .title{
      display:flex;flex-direction:column;
    }
    .title h1{margin:0;font-size:18px}
    .title p{margin:0;font-size:12px;color:var(--muted)}

    /* body */
    .chat-body{display:flex;flex-direction:row;gap:20px;padding:18px;flex:1;overflow:hidden}
    .left{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }
    .chat-window{
      background:linear-gradient(180deg,#fff,#fbfdff);
      border-radius:10px;
      padding:14px;
      box-shadow:inset 0 0 0 1px #f3f6fb;
      flex:1;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .message{max-width:78%;padding:10px 14px;border-radius:12px;line-height:1.4;word-wrap:break-word;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
    .msg-user{align-self:flex-end;background:var(--user);border-bottom-right-radius:4px}
    .msg-bot{align-self:flex-start;background:var(--bot);border-bottom-left-radius:4px}

    .meta{font-size:11px;color:var(--muted);margin:6px 8px}

    /* input area */
    .composer{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:12px;
    }
    .composer input[type="text"]{
      flex:1;padding:12px 14px;border-radius:10px;border:1px solid #e6eefc;font-size:15px;outline:none;
      box-shadow:0 1px 2px rgba(16,24,40,0.02)
    }
    .composer button{
      background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600;
      box-shadow:0 6px 16px rgba(37,99,235,0.18)
    }
    .composer button:disabled{opacity:0.6;cursor:not-allowed}

    /* right info panel */
    .right{
      width:260px;min-width:200px;
      display:flex;flex-direction:column;gap:12px;
    }
    .panel{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(16,24,40,0.03)}
    .panel h3{margin:0 0 6px 0;font-size:14px}
    .panel p{margin:0;font-size:13px;color:var(--muted)}

    /* typing indicator */
    .typing{
      display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:rgba(0,0,0,0.04)
    }
    .dot{width:6px;height:6px;border-radius:50%;background:#444;opacity:0.9;animation:blink 1s infinite}
    .dot:nth-child(2){animation-delay:0.15s}
    .dot:nth-child(3){animation-delay:0.3s}
    @keyframes blink{0%,80%,100%{opacity:0.2}40%{opacity:1}}

    /* small screens */
    @media (max-width:720px){
      .app{min-height:100vh;border-radius:0}
      .chat-body{flex-direction:column}
      .right{width:100%}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="AI PhyBot chat app">
    <div class="app-header">
      <div class="logo">PHY</div>
      <div class="title">
        <h1>AI PhyBot</h1>
        <p>A physics tutor + search + calculator</p>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="clearLocalBtn" style="background:transparent;border:none;color:var(--muted);cursor:pointer">Clear local chat</button>
      </div>
    </div>

    <div class="chat-body">
      <div class="left">
        <div class="chat-window" id="chatWindow" aria-live="polite"></div>

        <div class="composer" aria-label="Message composer">
          <input id="userInput" type="text" placeholder="Ask about physics, calculate, or search the web..." aria-label="Message input">
          <button id="sendBtn">Send</button>
          <button id="clearServerBtn" onclick="clearMemory()">Clear Chat</button>
        </div>
      </div>

      <aside class="right">
        <div class="panel">
          <h3>How to use</h3>
          <p>Ask theory questions, numeric calculations (e.g. <code>2*9.8*5</code>), or requests for recent info (e.g. "latest LHC results").</p>
        </div>

        <div class="panel">
          <h3>Status</h3>
          <p id="statusText">Disconnected</p>
        </div>
	
        <div class="panel">
          <h3>Session</h3>
          <p id="sessionInfo">Messages saved to your browser. Memory is local + server also saves conversation.</p>
        </div>
      </aside>
      

    </div>
  </div>

  <script>
    // ----- Config -----
    const CHAT_ENDPOINT = '/chat'; // FastAPI backend route
    const STORAGE_KEY = 'ai_phybot_messages_v1';

    // ----- UI elements -----
    const chatWindow = document.getElementById('chatWindow');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const statusText = document.getElementById('statusText');
    const clearLocalBtn = document.getElementById('clearLocalBtn'); 
    const clearServerBtn = document.getElementById('clearServerBtn');

    let isThinking = false;

    // ----- Helpers -----
    function formatMessage(text, from='bot') {
      const el = document.createElement('div');
      el.className = 'message ' + (from==='user' ? 'msg-user' : 'msg-bot');
      el.textContent = text;
      return el;
    }

    function showTypingIndicator(){
      const wrap = document.createElement('div');
      wrap.className = 'typing';
      wrap.id = 'typingIndicator';
      wrap.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span> Thinking';
      chatWindow.appendChild(wrap);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    function hideTypingIndicator(){
      const t = document.getElementById('typingIndicator');
      if(t) t.remove();
    }

    function saveMessagesToLocal(messages){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
    }
    function loadMessagesFromLocal(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        return JSON.parse(raw);
      } catch(e) {
        console.warn('Failed to parse local messages, clearing.', e);
        localStorage.removeItem(STORAGE_KEY);
        return [];
      }
    }

    function renderMessages(messages){
      chatWindow.innerHTML = '';
      messages.forEach(m => {
        const node = formatMessage(m.content, m.role);
        chatWindow.appendChild(node);
      });
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // ----- Initialization: render saved messages -----
    let messages = loadMessagesFromLocal();
    if(messages.length){
      renderMessages(messages);
      statusText.textContent = 'Loaded saved messages';
    } else {
      // greet
      const greet = {role:'bot', content: "Hi — I'm AI PhyBot. Ask me physics questions, request calculations, or ask for recent physics news."};
      messages = [greet];
      saveMessagesToLocal(messages);
      renderMessages(messages);
      statusText.textContent = 'Ready';
    }

    // ----- Send a message -----
    async function sendMessage(){
      const text = userInput.value.trim();
      if(!text || isThinking) return;
      isThinking = true;
      statusText.textContent = 'Sending...';
      sendBtn.disabled = true;

      // add user message locally
      const userMsg = {role:'user', content: text};
      messages.push(userMsg);
      saveMessagesToLocal(messages);
      chatWindow.appendChild(formatMessage(text,'user'));
      chatWindow.scrollTop = chatWindow.scrollHeight;
      userInput.value = '';

      // show typing
      showTypingIndicator();

      // call backend
      try {
        const resp = await fetch(CHAT_ENDPOINT, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ message: text })
        });

        if(!resp.ok){
          throw new Error('Server error: ' + resp.status);
        }
        const data = await resp.json();
        const botText = data.response ?? 'No response from server.';
        // save and render
        const botMsg = {role:'bot', content: botText};
        messages.push(botMsg);
        saveMessagesToLocal(messages);

        hideTypingIndicator();
        chatWindow.appendChild(formatMessage(botText,'bot'));
        chatWindow.scrollTop = chatWindow.scrollHeight;
        statusText.textContent = 'Ready';
      } catch(err){
        hideTypingIndicator();
        const errText = 'Error: ' + (err.message || err);
        const errMsg = {role:'bot', content: errText};
        messages.push(errMsg);
        saveMessagesToLocal(messages);
        chatWindow.appendChild(formatMessage(errText,'bot'));
        statusText.textContent = 'Disconnected';
        console.error(err);
      } finally {
        isThinking = false;
        sendBtn.disabled = false;
      }
    }

    // ----- Clear local chat -----
    clearLocalBtn.addEventListener('click', () => {
      if(!confirm('Clear local chat history? This only clears your browser storage.')) return;
      messages = [];
      saveMessagesToLocal(messages);
      chatWindow.innerHTML = '';
      statusText.textContent = 'Local history cleared';
    });

    // ----- Events -----
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });
    async function clearMemory() {
  if(!confirm('This will also clear memory on the server. Continue?')) return;
  const response = await fetch("/clear", { method: "POST" });
  const data = await response.json();
  messages = [];
  saveMessagesToLocal(messages);
  chatWindow.innerHTML = "<p><i>Server + local memory cleared. Start a new chat!</i></p>";
  alert(data.message);
}

    // focus input
    userInput.focus();
  </script>
</body>
</html>

